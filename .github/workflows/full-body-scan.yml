name: ðŸ›°ï¸ Full Body Scan - Chaos-style

on:
  workflow_dispatch:
  schedule:
    - cron: '13 04 * * 4' # Week 1: Thursday at 04:13 UTC
    - cron: '42 02 * * 1' # Week 2: Monday at 02:42 UTC
    - cron: '29 06 * * 5' # Week 3: Friday at 06:29 UTC
    - cron: '57 03 * * 0' # Week 4: Sunday at 03:57 UTC

jobs:
  scan:
    permissions:
      contents: read
      security-events: write
      actions: read
    container:
      image: semgrep/semgrep
    name: ðŸ” Weekly Deep Scan
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ§¾ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŽ›ï¸ Set Codename Roster
        id: setnames
        run: |
          echo "JUDY=ðŸ’‹ Judy's Backup Failed Again" >> $GITHUB_ENV
          echo "BILLY=ðŸŽ¿ Billy Went Skiing With No Helmet" >> $GITHUB_ENV
          echo "KELVIN=ðŸ’° Kelvin Charged It to the Church Card" >> $GITHUB_ENV
          echo "JESSE=ðŸ™ Jesse Baptized a Branch in Production" >> $GITHUB_ENV

      - name: ðŸ“º Determine Episode Rotation
        id: episodes
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            WEEK=$(date +%U)
            THIS=$(( WEEK % 4 ))

            declare -a CODES
            CODES[0]="${{ env.JUDY }}"
            CODES[1]="${{ env.BILLY }}"
            CODES[2]="${{ env.KELVIN }}"
            CODES[3]="${{ env.JESSE }}"

            echo "this_week=${CODES[$THIS]}" >> $GITHUB_OUTPUT
          else
            echo "this_week=ðŸŽ¬ On-Demand Special: The One Where We Scan Everything" >> $GITHUB_OUTPUT
          fi

      - name: ðŸŽ¬ Now Playing
        run: |
          echo ""
          echo "ðŸŽ¬ NOW PLAYING: ${{ steps.episodes.outputs.this_week }}"
          echo "ðŸŽ§ Soundtrack for this episode:"
          echo "â–¶ï¸ https://www.youtube.com/watch?v=R-znj7Uf9Oo"
          echo ""
          echo "ðŸ’¡ Hit play while we run this week's full-body scan. It's more fun that way."

      - name: ðŸ§¼ Run Security Scan
        id: security-scan
        run: |
          semgrep ci \
            --publish \
            --publish-token ${{ secrets.SEMGREP_APP_TOKEN }} \
            --publish-deployment ${{ secrets.SEMGREP_DEPLOYMENT_ID }} \
            --sarif semgrep.sarif \
            --json   semgrep.json

      - name: ðŸ“¤ Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
        if: always()

      - name: ðŸ“ Summarize Full Body Scan
        if: always()
        run: |
          echo "ðŸ” Full Body Scan Episode: ${{ steps.episodes.outputs.this_week }}" >> $GITHUB_STEP_SUMMARY
          issues=$(jq '.results | length' semgrep.json)
          echo "ðŸ˜µ Found **$issues** issues in changed files" >> $GITHUB_STEP_SUMMARY
