name: ðŸ¾ Release Please

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4
      - name: âš™ï¸ Get Volta Node Version
        id: get-volta-node
        run: |
          version=$(jq -r .volta.node package.json)
          echo "node-version=$version" >> $GITHUB_OUTPUT
      - name: ðŸ¤– Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ steps.get-volta-node.outputs.node-version }}
      - name: ðŸ“¥ Install Dependencies
        run: npm install
      - name: ðŸ—ï¸ Build Project
        run: npm run build
      - name: ðŸ§ª Run Tests
        run: npm test
      - name: ðŸ“¦ Package Artifact
        run: |
          mkdir -p artifact
          zip -r artifact/release-artifact.zip .
      - name: ðŸš€ Create Release
        id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.MY_RELEASE_PLEASE_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
      - name: ðŸ“¤ Upload Release Artifact
        if: ${{ steps.release.outputs.release_created }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ steps.release.outputs.tag_name }} artifact/release-artifact.zip
      - name: ðŸ“ Report Release Status
        if: always()
        run: |
          # Output release status and tag to the Actions summary
          if [ "${{ steps.release.outputs.release_created }}" == "true" ]; then
            echo "ðŸŽ‰ Release created: ${{ steps.release.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ¤” No new release created. Proposed tag: ${{ steps.release.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          fi
